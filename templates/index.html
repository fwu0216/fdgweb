{% extends "layout.html" %}
{% block content %}
<h2>F18-FDG 分装计算器</h2>
<form method="POST" id="weight-form">
  <label>系数 (默认0.15): 
    <input type="text" name="coeff" value="{{ request.form.get('coeff', '0.15') }}">
  </label><br>

  <div id="weights-container">
    {% set weight_fields = [] %}
    {% for key, val in request.form.items() if key.startswith('weight') %}
      {% set _ = weight_fields.append(val) %}
    {% endfor %}
    {% if weight_fields %}
      {% for i, val in enumerate(weight_fields, start=1) %}
        <label>体重{{ i }}: 
          <input type="number" name="weight{{ i }}" step="0.1" value="{{ val }}">
        </label><br>
      {% endfor %}
    {% else %}
      <label>体重1: <input type="number" name="weight1" step="0.1"></label><br>
      <label>体重2: <input type="number" name="weight2" step="0.1"></label><br>
      <label>体重3: <input type="number" name="weight3" step="0.1"></label><br>
    {% endif %}
  </div>
  <button type="button" onclick="addWeight()">+ 添加患者</button><br><br>

  <label>第一批人数: 
    <input type="number" name="batch1_max" value="{{ request.form.get('batch1_max', 8) }}">
  </label><br>

  <label>
    <input type="checkbox" name="enable_batch2" 
      {% if request.form.get('enable_batch2', 'on') == 'on' %}checked{% endif %}> 启用第二批
  </label>
  <label>第二批人数: 
    <input type="number" name="batch2_max" value="{{ request.form.get('batch2_max', 6) }}">
  </label><br>

  <label>
    <input type="checkbox" name="enable_batch3" 
      {% if request.form.get('enable_batch3', 'on') == 'on' %}checked{% endif %}> 启用第三批
  </label>
  <label>第三批人数: 
    <input type="number" name="batch3_max" value="{{ request.form.get('batch3_max', 3) }}">
  </label><br>

  <button type="submit">计算</button>
</form>

{% if error_msg %}
  <p style="color: red; font-size:18px;">{{ error_msg }}</p>
{% endif %}

{% if results %}
  <h3>结果</h3>
  {% for batch_name, batch_data in batches %}
    <h4>{{ batch_name }} 总分装剂量: {{ batch_data|sum(attribute='分装剂量(mCi)')|round(2) }} mCi</h4>
    <table>
      <tr><th>批次</th><th>编号</th><th>体重</th><th>注射时间</th><th>分装时间</th><th>分装剂量</th></tr>
      {% for row in batch_data %}
        <tr>
          <td>{{ row["批次"] }}</td>
          <td>{{ row["编号"] }}</td>
          <td>{{ row["体重(kg)"] }}</td>
          <td>{{ row["注射时间"] }}</td>
          <td>{{ row["分装时间"] }}</td>
          <td>{{ row["分装剂量(mCi)"] }}</td>
        </tr>
      {% endfor %}
    </table>
  {% endfor %}
{% endif %}

<script>
let weightCount = {{ weight_fields|length if weight_fields else 3 }};
function addWeight() {
    weightCount += 1;
    const container = document.getElementById("weights-container");
    const newField = document.createElement("div");
    newField.innerHTML = `<label>体重${weightCount}: 
        <input type="number" name="weight${weightCount}" step="0.1">
      </label><br>`;
    container.appendChild(newField);
}
</script>
{% endblock %}
